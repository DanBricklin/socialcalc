<!DOCTYPE html>
<html>
<head>
    <title>Bootstrap 实例</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.1.0/css/bootstrap.min.css">
    <script src="https://cdn.staticfile.org/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://cdn.staticfile.org/popper.js/1.12.5/umd/popper.min.js"></script>
    <script src="https://cdn.staticfile.org/twitter-bootstrap/4.1.0/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="socialcalcconstants.js"></script>
    <script type="text/javascript" src="socialcalc-3.js"></script>
    <script type="text/javascript" src="socialcalctableeditor.js"></script>
    <script type="text/javascript" src="formatnumber2.js"></script>
    <script type="text/javascript" src="formula1.js"></script>
    <script type="text/javascript" src="socialcalcpopup.js"></script>
    <script type="text/javascript" src="socialcalcspreadsheetcontrol.js"></script>
    <script type="text/javascript" src="socialcalcworkbook.js"></script>
    <link rel="stylesheet" type="text/css" href="socialcalc.css">
    <link rel="stylesheet" type="text/css" href="index.css">
</head>
<body>

<div class="container-fluid">
    <div>
        <ul class="nav">
            <li class="nav-item">
                <a class="nav-link" href="#">File</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#">Edit</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#">View</a>
            </li>
            <li class="nav-item">
                <a class="nav-link disabled" href="#">Help</a>
            </li>
        </ul>
    </div>
    <hr/>
    <div class="btn-group btn-group-sm">
        <input type="file" name="inputFile" id="inputFile" value="" multiple="multiple"/>
        <a href="" download="a.txt" id="aSave">download</a>
        <button type="button" class="btn btn-info" id="buttonOpen">Open</button>
        <button type="button" class="btn btn-info" id="buttonSave">Save</button>
        <button type="button" class="btn btn-info">Copy</button>
        <button type="button" class="btn btn-info">Cut</button>
        <button type="button" class="btn btn-info">Paste</button>
    </div>
    <hr/>
    <div>
        <form class="form-inline">
            <label for="formula">Formula:</label>
            <input type="email" class="form-control" id="formula" placeholder="=A1+A2">
        </form>
    </div>
    <hr/>
    <div>
        <div class="tab-content" id="sheet"></div>
        <ul class="nav nav-tabs" role="tablist">
            <li class="nav-item">
                <a class="nav-link active" data-toggle="tab" href="#sheet1" id="sheet1">sheet1</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-toggle="tab" href="#sheet2" id="sheet2">sheet2</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-toggle="tab" href="#sheet3" id="sheet3">sheet3</a>
            </li>
            <li class="add-sheet" id="add-sheet-btn">
                <img src="./images/add-sheet.png" >
            </li>
        </ul>
        
    </div>
    <div class="alert alert-success">
        指定操作成功提示信息。
    </div>
</div>
<script>
    var workbook = new SocialCalc.Workbook();
    workbook.addNewSheet("sheet1");
    workbook.addNewSheet("sheet2");
    workbook.addNewSheet("sheet3");
    workbook.selectSheet("sheet1", "sheet", "formula");

    $("#add-sheet-btn").click(function(e) {
        const length = $(this).siblings().length
        const newLi = $('<li class="nav-item"><a class="nav-link" data-toggle="tab" href="#sheet'+ (length + 1) +'" id="sheet'+ (length + 1) +'">sheet'+ (length + 1) +'</a></li>')
        const newId = "sheet"+ ( length + 1 )
        $(this).before(newLi)
        workbook.addNewSheet(newId);
    })
 
    $(document).on('click', ".nav-item", function(){
        const id = $(this).children().attr("ID")
        workbook.selectSheet(id, "sheet", "formula");
    })

    $("#aSave").click(function (e) {
        var str = workbook.generateFile();
        alert(str);
        var fileStr = "data:text/plain;charset=utf-8," + str;
        $('#aSave').attr('href',fileStr);
    });
    $("#inputFile").change(function (e) {
        for (var i = 0;i < this.files.length;i++) {
            var file = this.files[i];
            console.log(file);
            var fr = new FileReader();
            fr.readAsText(file);
            fr.onload = function () {
                console.log(this.result);
                var json = JSON.parse(this.result);
                for (var name in json) {
                    var sheetInfo = workbook.sheetInfoMap[name];
                    if (sheetInfo) {
                        sheetInfo.sheet.ParseSheetSave(json[name]);
                    } else {
                        workbook.addNewSheet(name, json[name]);
                    }
                }
                workbook.refresh();

            }
        }
    });
</script>
</body>
</html>