<!DOCTYPE html>
<html>
<head>
    <title>训练计划数据报表</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.1.0/css/bootstrap.min.css">
    <script src="https://cdn.staticfile.org/jquery/3.2.1/jquery.min.js"></script>
    <script src="./dist/jquery.calendar.js"></script>
    <script src="https://cdn.staticfile.org/popper.js/1.12.5/umd/popper.min.js"></script>
    <script src="https://cdn.staticfile.org/twitter-bootstrap/4.1.0/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="js/socialcalcconstants.js"></script>
    <script type="text/javascript" src="js/socialcalc-3.js"></script>
    <script type="text/javascript" src="js/socialcalctableeditor.js"></script>
    <script type="text/javascript" src="js/formatnumber2.js"></script>
    <script type="text/javascript" src="js/formula1.js"></script>
    <script type="text/javascript" src="js/socialcalcpopup.js"></script>
    <script type="text/javascript" src="js/socialcalcworkbook.js"></script>
    <script type="text/javascript" src="js/socialcalcactionbtns.js"></script>
    <link rel="stylesheet" type="text/css" href="css/socialcalc.css">
    <link rel="stylesheet" type="text/css" href="css/index.css">
</head>
<body>

<div class="container-fluid">
    <div>
        <ul class="nav">
            <li class="nav-item">
                <a class="nav-link" href="#">File</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#">Edit</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#">View</a>
            </li>
            <li class="nav-item">
                <a class="nav-link disabled" href="#">Help</a>
            </li>
        </ul>
    </div>

    <div class="btn-group btn-group-sm">
        <img class="icon-btn" src="./images/save.png" title="保存至服务器" data-toggle="modal" data-target="#save-to-server">
        <label class="input-file">
            <input type="file" name="inputFile" id="inputFile" value="" multiple="multiple"/>
            <img class="icon-btn" src="./images/input_file.png" title="选择文件" >
        </label>
        <img class="icon-btn" src="./images/import.png" title="导入远程文档" data-toggle="modal" data-target="#myModal">
        <img class="icon-btn" src="./images/share.png" title="分享链接" data-toggle="modal" data-target="#buttonVisitLink" id="show-share-link" >

        <div class="action-btns"></div>
        <a href="" download="a.txt" id="aSave">
            <img class="icon-btn" src="./images/download.png" title="下载excel文档">
        </a>
        

        <!-- <button type="button" class="btn btn-primary" id="buttonSave">SaveToServer</button> -->
        <!-- <button type="button" class="btn btn-primary" id="buttonVisitLink">VisitLink</button> -->
    </div>

    <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <span class="modal-title" id="myModalLabel">
                        引用云端表格
                    </span>
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                        &times;
                    </button>
                </div>
                <div class="modal-body">
                    <label>填写数据源: </label> <input type="text" id="inputRef" value="biz=personalize&table=训练计划创建情况&minDate=20181030&maxDate=20181031">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">关闭
                    </button>
                    <button type="button" class="btn btn-primary" id="buttonLoad">
                        加载
                    </button>
                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal -->
    </div>

    <div class="modal fade" id="buttonVisitLink" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <span class="modal-title" id="myModalLabel">
                        分享链接
                    </span>
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                        &times;
                    </button>
                </div>
                <div class="modal-body"></div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal -->
    </div>

    <div class="modal fade" id="save-to-server" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <span class="modal-title" id="myModalLabel">
                        填写生成文件的文件名
                    </span>
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                        &times;
                    </button>
                </div>
                <div class="modal-body">
                    <input placeholder="填写文件名" />
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                    <button type="button" class="btn btn-primary" id="buttonSave">保存</button>
                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal -->
    </div>

    <!-- <div class="btn-group btn-group-sm">
        <div class="input-group-prepend">
            <span class="input-group-text">Url</span>
        </div>
        <input type="text" id="inputRef" value="biz=personalize&table=训练计划创建情况&minDate=20181030&maxDate=20181031">
        <button type="button" class="btn btn-primary" id="buttonLoad">load</button>
    </div> -->
    <div>
        <form class="form-inline">
            <label for="formula"><img src="./images/fx.png"></label>
            <input type="text" id="formula" placeholder="=A1+A2">
        </form>
    </div>

    <div>
        <div class="tab-content" id="sheet"></div>
        <ul class="nav nav-tabs" role="tablist">
            <li class="nav-item">
                <a class="nav-link active" data-toggle="tab" href="#sheet1" id="sheet1">sheet1</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-toggle="tab" href="#sheet2" id="sheet2">sheet2</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-toggle="tab" href="#sheet3" id="sheet3">sheet3</a>
            </li>
            <li class="add-sheet" id="add-sheet-btn">
                <img src="./images/add-sheet.png" >
            </li>
        </ul>
        
    </div>
    <div class="alert alert-success">
        指定操作成功提示信息。
    </div>
</div>
<script>
    var workbook = new SocialCalc.Workbook();
    workbook.addNewSheet("sheet1");
    workbook.addNewSheet("sheet2");
    workbook.addNewSheet("sheet3");
    workbook.selectSheet("sheet1", "sheet", "formula");

    $("#add-sheet-btn").click(function(e) {
        const length = $(this).siblings().length
        const newLi = $('<li class="nav-item"><a class="nav-link" data-toggle="tab" href="#sheet'+ (length + 1) +'" id="sheet'+ (length + 1) +'">sheet'+ (length + 1) +'</a></li>')
        const newId = "sheet"+ ( length + 1 )
        $(this).before(newLi)
        workbook.addNewSheet(newId);
    })
 
    $(document).on('click', ".nav-item", function(){
        const id = $(this).children().attr("ID")
        workbook.selectSheet(id, "sheet", "formula");
    })

    $("#aSave").click(function (e) {
        var str = workbook.generateFile();
        alert(str);
        var fileStr = "data:text/plain;charset=utf-8," + str;
        $('#aSave').attr('href',fileStr);
    });
    $("#inputFile").change(function (e) {
        for (var i = 0; i < this.files.length; i++) {
            var file = this.files[i];
            console.log(file);
            var fr = new FileReader();
            fr.readAsText(file);
            fr.onload = function () {
                console.log(this.result);
                loadFileData(this.result);
            }
        }
    });
    function loadRemoteData (sheet, info) {
        if (sheet.remote && sheet.remote.length > 0) {
            // var ref = "biz=personalize&table=训练计划创建情况&minDate=20181030&maxDate=20181031";
            var url = "/api/stat?" + info.ref;
            $.get(url, function (jsonstr, status) {
                console.log(jsonstr);
                var data = JSON.parse(jsonstr);
                if (data.code != 0) {
                    alert("failed to load " + url);
                    return;
                }
                workbook.updateRemoteData(sheet, info, data.result);
            });
        }
    }
    $("#buttonLoad").click(function() {
        var ref = $("#inputRef").val();
        if (!workbook.editor.range.hasrange) {
            alert("please select a range");
            return;
        }
        var sheet = workbook.getCurrentSheet();
        var info = workbook.addRemoteInfo(sheet, ref);
        loadRemoteData(sheet, info);
        workbook.refresh();
    });
    function getValueFromQuery (name) {
        var reg = new RegExp("(^|&)"+ name +"=([^&]*)(&|$)");
        var r = window.location.search.substr(1).match(reg);
        if(r!=null)return  unescape(r[2]); return null;
    }
    function loadFileData (fileData) {
        var json = JSON.parse(fileData);
        for (var name in json) {
            var sheet = workbook.addNewSheet(name, json[name]);
            for (var j = 0; j < sheet.remote.length; ++j) {
                loadRemoteData(sheet, sheet.remote[j]);
            }
        }
        workbook.refresh();
    }
    $("#show-share-link").click(function () {
        var link = window.location.origin + window.location.pathname + "?fileName=first.ss&owner=mabaiming";
        $("#buttonVisitLink .modal-body").html(link)
    });
    $("#buttonSave").click(function () {
        var content = workbook.generateFile();
        $.post("/api/file", {
                fileName:"first.ss",
                owner:"mabaiming",
                content: content
            }, function(jsonstr) {
            console.log(jsonstr);
            var data = JSON.parse(jsonstr);
            if (data.code != 0) {
                alert("failed to load " + url);
                return;
            }
            alert("OK");
        });
    });
    $(document).ready(function() {
        var fileName = getValueFromQuery("fileName");
        var owner = getValueFromQuery("owner");
        if (!fileName || !owner) {
            return;
        }
        $.get("/api/file?fileName=" + fileName + "&owner=" + owner, function (jsonstr, status) {
            console.log(jsonstr);
            var data = JSON.parse(jsonstr);
            if (data.code != 0) {
                alert("failed to load " + url);
                return;
            }
            var content = data.result.content;
            loadFileData(content);
        });
    });

    $(".select-time").showCalendar();

</script>
</body>
</html>